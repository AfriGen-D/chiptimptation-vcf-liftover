/*
========================================================================================
    Singularity Configuration
========================================================================================
    Singularity-specific settings for the chiptimptation-vcf-liftover pipeline
========================================================================================
*/

singularity {
    enabled = true
    autoMounts = true
    cacheDir = "${params.singularity_cache_dir}"
    runOptions = "--bind ${params.scratch_dir}"
}

process {
    // Container assignments by label
    withLabel: 'crossmap' {
        container = 'docker://mamana/crossmap:latest'
        memory = { 8.GB * task.attempt }
        cpus = 2
        time = { 4.h * task.attempt }
        errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
        maxRetries = 3
    }
    
    withLabel: 'vcf_processing' {
        container = 'docker://mamana/vcf-processing:latest'
        memory = { 16.GB * task.attempt }
        cpus = 4
        time = { 2.h * task.attempt }
        errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
        maxRetries = 3
    }
    
    withLabel: 'imputation' {
        container = 'docker://mamana/vcf-processing:latest'
        memory = { 12.GB * task.attempt }
        cpus = 2
        time = { 3.h * task.attempt }
        errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
        maxRetries = 3
    }
    
    withLabel: 'general' {
        container = 'docker://mamana/vcf-processing:latest'
        memory = { 4.GB * task.attempt }
        cpus = 1
        time = { 1.h * task.attempt }
        errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
        maxRetries = 2
    }

    withLabel: 'python' {
        container = 'quay.io/biocontainers/python:3.9--1'
        memory = { 4.GB * task.attempt }
        cpus = 1
        time = { 1.h * task.attempt }
        errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
        maxRetries = 2
    }

    withLabel: 'samtools' {
        container = 'quay.io/biocontainers/samtools:1.17--h00cdaf9_0'
        memory = { 4.GB * task.attempt }
        cpus = 1
        time = { 1.h * task.attempt }
        errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
        maxRetries = 2
    }
    
    // Fallback containers (biocontainers) - uncomment if mamana containers are unavailable
    /*
    withLabel: 'crossmap' {
        container = 'quay.io/biocontainers/crossmap:0.6.4--pyhdfd78af_0'
    }
    
    withLabel: 'vcf_processing' {
        container = 'quay.io/biocontainers/bcftools:1.17--haef29d1_0'
    }
    
    withLabel: 'general' {
        container = 'quay.io/biocontainers/python:3.9--1'
    }
    */
}

// Singularity-specific environment variables
env {
    SINGULARITY_CACHEDIR = "${params.singularity_cache_dir}"
    TMPDIR = "${params.scratch_dir}"
}
