/*
========================================================================================
    Docker Configuration
========================================================================================
    Docker-specific settings for the chiptimptation-vcf-liftover pipeline
========================================================================================
*/

docker {
    enabled = true
    userEmulation = true
    runOptions = '-u $(id -u):$(id -g)'
}

process {
    // Container assignments by label
    withLabel: 'crossmap' {
        container = 'mamana/crossmap:latest'
        memory = { 8.GB * task.attempt }
        cpus = 2
        time = { 4.h * task.attempt }
        errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
        maxRetries = 3
    }
    
    withLabel: 'vcf_processing' {
        container = 'mamana/vcf-processing:latest'
        memory = { 16.GB * task.attempt }
        cpus = 4
        time = { 2.h * task.attempt }
        errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
        maxRetries = 3
    }
    
    withLabel: 'imputation' {
        container = 'mamana/vcf-processing:latest'
        memory = { 12.GB * task.attempt }
        cpus = 2
        time = { 3.h * task.attempt }
        errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
        maxRetries = 3
    }
    
    withLabel: 'general' {
        container = 'mamana/vcf-processing:latest'
        memory = { 4.GB * task.attempt }
        cpus = 1
        time = { 1.h * task.attempt }
        errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
        maxRetries = 2
    }

    withLabel: 'python' {
        container = 'python:3.9-slim'
        memory = { 4.GB * task.attempt }
        cpus = 1
        time = { 1.h * task.attempt }
        errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
        maxRetries = 2
    }

    withLabel: 'samtools' {
        container = 'quay.io/biocontainers/samtools:1.17--h00cdaf9_0'
        memory = { 4.GB * task.attempt }
        cpus = 1
        time = { 1.h * task.attempt }
        errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
        maxRetries = 2
    }
    
    // Fallback containers (biocontainers) - uncomment if mamana containers are unavailable
    /*
    withLabel: 'crossmap' {
        container = 'quay.io/biocontainers/crossmap:0.6.4--pyhdfd78af_0'
    }
    
    withLabel: 'vcf_processing' {
        container = 'quay.io/biocontainers/bcftools:1.17--haef29d1_0'
    }
    
    withLabel: 'general' {
        container = 'python:3.9-slim'
    }
    */
}

// Docker-specific environment variables
env {
    TMPDIR = '/tmp'
}
